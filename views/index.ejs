
<!-- Google OAuth Playground Style Layout -->
<div class="playground-container">
    <!-- Left Sidebar -->
    <div class="playground-sidebar">
        <!-- Step 1: Select & authorize APIs -->
        <div class="step-section" id="step1">
            <div class="step-header" onclick="toggleStep(1)">
                <span class="step-toggle">▼</span>
                <strong>Step 1</strong> Select & authorize APIs
            </div>
            <div class="step-content">
                <p class="step-description">
                    Select the scope for the APIs you would like to access or input your own OAuth scopes below. 
                    Then click the <strong>"Authorize APIs"</strong> button.
                </p>

                <!-- API Scopes List -->
                <div class="api-scopes">
                    <!-- User Profile & Identity -->
                    <div class="scope-group">
                        <div class="scope-group-header">
                            <input type="checkbox" id="user-profile-apis" class="scope-group-checkbox">
                            <label for="user-profile-apis"><strong>User Profile & Identity</strong></label>
                        </div>
                        <div class="scope-items">
                            <div class="scope-item">
                                <input type="checkbox" id="user-read" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="user-read">User.Read</label>
                            </div>
                            <div class="scope-item">
                                <input type="checkbox" id="people-read" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="people-read">People.Read</label>
                            </div>
                            <div class="scope-item">
                                <input type="checkbox" id="contacts-read" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="contacts-read">Contacts.Read</label>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar & Scheduling -->
                    <div class="scope-group">
                        <div class="scope-group-header">
                            <input type="checkbox" id="calendar-apis" class="scope-group-checkbox">
                            <label for="calendar-apis"><strong>Calendar & Scheduling</strong></label>
                        </div>
                        <div class="scope-items">
                            <div class="scope-item">
                                <input type="checkbox" id="calendars-read" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="calendars-read">Calendars.Read</label>
                            </div>
                            <div class="scope-item">
                                <input type="checkbox" id="calendars-readwrite" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="calendars-readwrite">Calendars.ReadWrite</label>
                            </div>
                        </div>
                    </div>

                    <!-- Files & SharePoint -->
                    <div class="scope-group">
                        <div class="scope-group-header">
                            <input type="checkbox" id="files-apis" class="scope-group-checkbox">
                            <label for="files-apis"><strong>Files & SharePoint</strong></label>
                        </div>
                        <div class="scope-items">
                            <div class="scope-item">
                                <input type="checkbox" id="files-read" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="files-read">Files.Read</label>
                            </div>
                            <div class="scope-item">
                                <input type="checkbox" id="files-read-all" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="files-read-all">Files.Read.All</label>
                            </div>
                            <div class="scope-item">
                                <input type="checkbox" id="sites-read-all" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="sites-read-all">Sites.Read.All</label>
                            </div>
                        </div>
                    </div>

                    <!-- Microsoft Teams & Chat -->
                    <div class="scope-group">
                        <div class="scope-group-header">
                            <input type="checkbox" id="teams-apis" class="scope-group-checkbox">
                            <label for="teams-apis"><strong>Microsoft Teams & Chat</strong></label>
                        </div>
                        <div class="scope-items">
                            <div class="scope-item">
                                <input type="checkbox" id="chat-read" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="chat-read">Chat.Read</label>
                            </div>
                            <div class="scope-item">
                                <input type="checkbox" id="chat-readwrite" class="scope-checkbox" onchange="updateCustomScopes()">
                                <label for="chat-readwrite">Chat.ReadWrite</label>
                            </div>
                        </div>
                    </div>
                
                    <!-- Authentication & Authorization -->
                    <div class="scope-group">
                        <div class="scope-group-header">
                            <input type="checkbox" id="auth-apis" class="scope-group-checkbox">
                            <label for="auth-apis"><strong>Authentication & Authorization</strong></label>
                        </div>
                        <div class="scope-items">
                            <div class="scope-item">
                                <input type="checkbox" id="offline-access" class="scope-checkbox" checked onchange="updateCustomScopes()">
                                <label for="offline-access">offline_access (Refresh Token)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden input for scopes (populated by checkboxes) -->
                <input type="hidden" id="customScopes" value="<%= (config.scopes && config.scopes.length > 0) ? config.scopes.join(' ') : '' %>">

                <!-- Selected Scopes Display -->
                <div class="selected-scopes-section mb-3">
                    <label class="form-label">Selected Scopes</label>
                    <div id="selectedScopesList" class="selected-scopes-list p-3 border rounded bg-light" style="min-height: 100px;">
                        <!-- Selected scopes will be populated here by JavaScript -->
                        <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No scopes selected</p>
                    </div>
                    <div class="form-text mb-2">
                        <i class="bi bi-info-circle"></i> The scopes you select above will appear here. You can also add custom scopes below.
                    </div>
                    
                    <!-- Custom Scope Input -->
                    <div class="input-group input-group-sm">
                        <input type="text" id="customScopeInput" class="form-control form-control-sm" 
                               placeholder="Add custom scope (e.g., https://graph.microsoft.com/Mail.Read)" 
                               onkeypress="handleCustomScopeKeyPress(event)">
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="addCustomScopeToList()">
                            <i class="bi bi-plus-circle"></i> Add
                        </button>
                    </div>
                    <div class="form-text">
                        <small class="text-muted">
                            Press Enter or click "Add Scope" to add a custom scope. 
                            Common format: https://graph.microsoft.com/[Permission]. Click the × next to any scope to remove it.
                        </small>
                    </div>
                </div>

                <!-- Configuration Fields -->
                <div class="config-section">
                    <h6 class="config-title">Configuration</h6>
                    <div class="config-field">
                        <label for="clientId" class="form-label">Client ID</label>
                        <input type="text" id="clientId" class="form-control" 
                               value="<%= config.clientId || '' %>" 
                               placeholder="Your Application (client) ID">
                    </div>
                    <div class="config-field">
                        <label for="clientSecret" class="form-label">Client Secret</label>
                        <input type="password" id="clientSecret" class="form-control"
                               value="<%= config.clientSecret || '' %>" 
                               placeholder="Your client secret value">
                    </div>
                    <div class="config-field">
                        <label for="tenantId" class="form-label">Tenant ID</label>
                        <input type="text" id="tenantId" class="form-control"
                               value="<%= config.tenantId || '' %>" 
                               placeholder="Your Directory (tenant) ID">
                    </div>
                    <div class="config-field">
                        <label for="redirectUri" class="form-label">Redirect URI</label>
                        <input type="text" id="redirectUri" class="form-control"
                               value="<%= config.redirectUri || 'http://localhost:3000/api/auth/callback' %>" 
                               placeholder="http://localhost:3000/api/auth/callback">
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> This must match the redirect URI configured in your Azure AD app registration. 
                            Default: <code>http://localhost:3000/api/auth/callback</code>
                        </div>
                    </div>
                </div>

                <!-- Authorize Button -->
                <button class="btn btn-primary authorize-btn" onclick="authorizeAPIs()">
                    <i class="bi bi-shield-check"></i> Authorize APIs
                </button>
            </div>
        </div>

        <!-- Step 2: Exchange authorization code for tokens -->
        <div class="step-section" id="step2">
            <div class="step-header <%= (config.clientId && config.tenantId && config.clientSecret) ? '' : 'disabled' %>" onclick="<%= (config.clientId && config.tenantId && config.clientSecret) ? 'toggleStep(2)' : '' %>">
                <span class="step-toggle">▶</span>
                <strong>Step 2</strong> Exchange authorization code for tokens
            </div>
            <div class="step-content" style="display: none;">
                <p class="step-description">
                    If you have an authorization code, you can exchange it for an access token.
                </p>
                
                <% if (currentToken) { %>
                    <div class="token-info">
                        <div class="token-field">
                            <label class="form-label">Access Token</label>
                            <div class="token-display">
                                <input type="text" class="form-control" value="<%= currentToken.access_token %>" readonly style="font-size: 11px;">
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToken('<%= currentToken.access_token %>')">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div class="token-expiration" id="tokenExpiration" data-expires="<%= currentToken.expires_at %>">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> <span id="expirationText">Calculating...</span>
                                </small>
                            </div>
                        </div>
                        <% if (currentToken.refresh_token) { %>
                        <div class="token-field mt-3">
                            <label class="form-label">Refresh Token</label>
                            <div class="token-display">
                                <input type="text" class="form-control" value="<%= currentToken.refresh_token %>" readonly style="font-size: 11px;">
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToken('<%= currentToken.refresh_token %>')">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Use this token with grant_type=refresh_token to get new access tokens
                            </small>
                        </div>
                        <% } %>
                        <div class="token-actions mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshToken(<%= currentToken.id %>)" <%= !currentToken.refresh_token ? 'disabled title="No refresh token available"' : '' %>>
                                <i class="bi bi-arrow-clockwise"></i> Use Refresh Token
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="revokeToken(<%= currentToken.id %>)">
                                <i class="bi bi-x-circle"></i> Revoke token
                            </button>
                        </div>
                    </div>
                <% } else { %>
                    <div class="no-token-message">
                        <p class="text-muted">No tokens available. Complete Step 1 first.</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Step 3: Configure request to API -->
        <div class="step-section" id="step3">
            <div class="step-header <%= currentToken ? '' : 'disabled' %>" onclick="<%= currentToken ? 'toggleStep(3)' : '' %>">
                <span class="step-toggle">▶</span>
                <strong>Step 3</strong> Configure request to API
            </div>
            <div class="step-content" style="display: none;">
                <!-- Available APIs List -->
                <div class="api-list-section mb-3">
                    <label class="form-label">Select an API to test</label>
                    <select id="apiSelector" class="form-select" onchange="loadSelectedAPI()">
                        <option value="">Choose a predefined API...</option>
                        <optgroup label="Profile">
                            <option value="profile-me">Get My Profile</option>
                            <option value="profile-photo">Get My Photo</option>
                            <option value="profile-update">Update My Profile</option>
                        </optgroup>
                        <optgroup label="Calendar">
                            <option value="calendar-main">Get My Calendar</option>
                            <option value="calendar-events">Get My Events</option>
                            <option value="calendar-today">Get Events Today</option>
                            <option value="calendar-week">Get Events This Week</option>
                            <option value="calendar-month">Get Events This Month</option>
                            <option value="calendar-create">Create Calendar Event</option>
                        </optgroup>
                        <optgroup label="Contacts">
                            <option value="contacts-list">Get My Contacts</option>
                            <option value="contacts-search">Search Contacts</option>
                            <option value="contacts-folders">Get Contact Folders</option>
                            <option value="contacts-create">Create Contact</option>
                        </optgroup>
                        <optgroup label="People">
                            <option value="people-list">Get People</option>
                            <option value="people-search">Search People</option>
                            <option value="people-relevant">Get Relevant People</option>
                        </optgroup>
                        <optgroup label="Microsoft Teams">
                            <option value="teams-joined">Get My Teams</option>
                            <option value="teams-channels">Get Team Channels</option>
                            <option value="teams-messages">Get Channel Messages</option>
                        </optgroup>
                        <optgroup label="Chat">
                            <option value="chat-list">Get My Chats</option>
                            <option value="chat-group">Get Group Chats Only</option>
                            <option value="chat-oneone">Get 1-on-1 Chats Only</option>
                            <option value="chat-messages">Get Chat Messages</option>
                            <option value="chat-send">Send Chat Message</option>
                        </optgroup>
                        <optgroup label="OneDrive">
                            <option value="drive-info">Get Drive Info</option>
                            <option value="drive-root">Get Root Folder Items</option>
                            <option value="drive-recent">Get Recent Files</option>
                            <option value="drive-search">Search Files</option>
                            <option value="drive-shared">Get Shared Files</option>
                        </optgroup>
                    </select>
                </div>

                <div class="api-request-form">
                    <div class="form-group">
                        <label class="form-label">HTTP Method</label>
                        <select id="httpMethod" class="form-select" onchange="toggleRequestBody()">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PATCH">PATCH</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Request URI</label>
                        <div class="uri-input">
                            <span class="uri-base">https://graph.microsoft.com/v1.0</span>
                            <input type="text" id="requestUri" class="form-control" placeholder="/me" value="/me" onchange="detectUriParameters(); detectQueryParameters();">
                            <button type="button" id="queryParamBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleQueryEditor()" style="display: none;" title="Edit Query Parameters">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Dynamic URI Parameters Section -->
                    <div id="uriParametersSection" class="form-group" style="display: none;">
                        <label class="form-label">URI Parameters</label>
                        <div id="uriParametersList" class="uri-parameters-container">
                            <!-- Dynamic parameter fields will be added here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="applyUriParameters()">
                            <i class="bi bi-arrow-repeat"></i> Apply Parameters to URI
                        </button>
                    </div>
                    
                    <!-- Query Parameters Editor Section -->
                    <div id="queryParametersSection" class="form-group" style="display: none;">
                        <label class="form-label">Query Parameters</label>
                        <div id="queryParametersList" class="query-parameters-container">
                            <!-- Dynamic query parameter fields will be added here -->
                        </div>
                        <div class="query-param-actions mt-2">
                            <button type="button" class="btn btn-sm btn-outline-success me-1" onclick="addQueryParameter()">
                                <i class="bi bi-plus-circle"></i> Add Parameter
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyQueryParameters()">
                                <i class="bi bi-arrow-repeat"></i> Apply to URI
                            </button>
                        </div>
                    </div>
                    <div id="requestBodySection" class="form-group" style="display: none;">
                        <label class="form-label">Request body</label>
                        <textarea id="requestBody" class="form-control" rows="8" placeholder="Enter request body (JSON)"></textarea>
                    </div>
                    <button class="btn btn-primary send-btn" onclick="sendAPIRequest()">
                        <i class="bi bi-send"></i> Send the request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel - Request/Response -->
    <div class="playground-content">
        <div class="content-header">
            <h5>Request / Response</h5>
        </div>
        <div class="content-body">
            <div id="requestResponse" class="request-response-area">
                <p class="no-request-message">No request.</p>
            </div>
        </div>
    </div>
</div>

<% if (originalTokenResponse) { %>
<script>
    window.originalTokenResponse = <%- JSON.stringify(originalTokenResponse) %>;
</script>
<% } %>
